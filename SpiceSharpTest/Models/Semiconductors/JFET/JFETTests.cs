using NUnit.Framework;
using SpiceSharp;
using SpiceSharp.Components;
using SpiceSharp.Simulations;
using System.Numerics;

namespace SpiceSharpTest.Models
{
    [TestFixture]
    public class JFETTests : Framework
    {
        /// <summary>
        /// Creates the specified JFET.
        /// </summary>
        private JFET CreateJFET(string name, string d, string g, string s, string model)
        {
            var fet = new JFET(name) { Model = model };
            fet.Connect(d, g, s);
            return fet;
        }

        private JFETModel CreateJFETModel(string name, string parameters)
        {
            var model = new JFETModel(name);
            ApplyParameters(model, parameters);
            return model;
        }

        [Test]
        public void When_SimpleDC_Expect_Reference()
        {
            // Build the circuit
            var ckt = new Circuit(
                new VoltageSource("V1", "g", "0", 0.0),
                new VoltageSource("V2", "d", "0", 0.0),
                CreateJFET("J1", "d", "g", "0", "JX"),
                CreateJFETModel("JX", "IS=1.500E-12 BETA=696.7E-6 VTO=-0.241")
            );

            // Build the simulation
            var dc = new DC("dc", new[] {
                new ParameterSweep("V1", new LinearSweep(0, 0.8, 0.1)),
                new ParameterSweep("V2", new LinearSweep(0.0, 5.0, 0.1))
            });

            // Create exports
            var exports = new IExport<double>[]
            {
                new RealPropertyExport(dc, "V1", "i"),
                new RealPropertyExport(dc, "V2", "i"),
            };

            // Create references
            double[][] references =
            [
                [
                    0.000000000000000e+00, 1.568598041229996e-12, 1.700000000000000e-12, 1.800000000000000e-12,
                    1.900000000000000e-12, 2.000000000000000e-12, 2.100000000000000e-12, 2.200000000000000e-12,
                    2.300000000000000e-12, 2.400000000000000e-12, 2.500000000000000e-12, 2.600000000000000e-12,
                    2.700000000000000e-12, 2.800000000000000e-12, 2.900000000000001e-12, 3.000000000000001e-12,
                    3.100000000000000e-12, 3.200000000000001e-12, 3.300000000000000e-12, 3.400000000000001e-12,
                    3.500000000000000e-12, 3.600000000000000e-12, 3.700000000000001e-12, 3.800000000000001e-12,
                    3.900000000000001e-12, 4.000000000000001e-12, 4.100000000000002e-12, 4.200000000000001e-12,
                    4.300000000000001e-12, 4.400000000000001e-12, 4.500000000000001e-12, 4.600000000000001e-12,
                    4.700000000000001e-12, 4.800000000000001e-12, 4.900000000000002e-12, 5.000000000000001e-12,
                    5.100000000000002e-12, 5.200000000000001e-12, 5.300000000000002e-12, 5.400000000000003e-12,
                    5.500000000000002e-12, 5.600000000000001e-12, 5.700000000000001e-12, 5.800000000000000e-12,
                    5.900000000000000e-12, 6.000000000000000e-12, 6.099999999999999e-12, 6.199999999999999e-12,
                    6.299999999999999e-12, 6.399999999999998e-12, 6.499999999999999e-12, -1.405031624861071e-10,
                    -7.025158124305357e-11, -6.868298320182360e-11, -6.855158124305357e-11, -6.845158124305359e-11,
                    -6.835158124305356e-11, -6.825158124305358e-11, -6.815158124305357e-11, -6.805158124305360e-11,
                    -6.795158124305357e-11, -6.785158124305356e-11, -6.775158124305356e-11, -6.765158124305358e-11,
                    -6.755158124305360e-11, -6.745158124305359e-11, -6.735158124305359e-11, -6.725158124305358e-11,
                    -6.715158124305360e-11, -6.705158124305360e-11, -6.695158124305357e-11, -6.685158124305359e-11,
                    -6.675158124305358e-11, -6.665158124305355e-11, -6.655158124305358e-11, -6.645158124305357e-11,
                    -6.635158124305359e-11, -6.625158124305361e-11, -6.615158124305361e-11, -6.605158124305358e-11,
                    -6.595158124305360e-11, -6.585158124305359e-11, -6.575158124305356e-11, -6.565158124305358e-11,
                    -6.555158124305355e-11, -6.545158124305357e-11, -6.535158124305354e-11, -6.525158124305356e-11,
                    -6.515158124305356e-11, -6.505158124305358e-11, -6.495158124305358e-11, -6.485158124305354e-11,
                    -6.475158124305357e-11, -6.465158124305356e-11, -6.455158124305358e-11, -6.445158124305358e-11,
                    -6.435158124305360e-11, -6.425158124305357e-11, -6.415158124305361e-11, -6.405158124305361e-11,
                    -6.395158124305353e-11, -6.385158124305355e-11, -6.842665459506546e-09, -3.491584310996328e-09,
                    -3.421332729753273e-09, -3.419764131712043e-09, -3.419632729753274e-09, -3.419532729753275e-09,
                    -3.419432729753273e-09, -3.419332729753274e-09, -3.419232729753272e-09, -3.419132729753273e-09,
                    -3.419032729753274e-09, -3.418932729753272e-09, -3.418832729753270e-09, -3.418732729753275e-09,
                    -3.418632729753272e-09, -3.418532729753270e-09, -3.418432729753272e-09, -3.418332729753276e-09,
                    -3.418232729753267e-09, -3.418132729753275e-09, -3.418032729753273e-09, -3.417932729753271e-09,
                    -3.417832729753272e-09, -3.417732729753273e-09, -3.417632729753275e-09, -3.417532729753276e-09,
                    -3.417432729753270e-09, -3.417332729753275e-09, -3.417232729753273e-09, -3.417132729753271e-09,
                    -3.417032729753275e-09, -3.416932729753273e-09, -3.416832729753268e-09, -3.416732729753272e-09,
                    -3.416632729753274e-09, -3.416532729753271e-09, -3.416432729753273e-09, -3.416332729753274e-09,
                    -3.416232729753275e-09, -3.416132729753276e-09, -3.416032729753274e-09, -3.415932729753272e-09,
                    -3.415832729753273e-09, -3.415732729753278e-09, -3.415632729753272e-09, -3.415532729753270e-09,
                    -3.415432729753275e-09, -3.415332729753276e-09, -3.415232729753274e-09, -3.415132729753275e-09,
                    -3.415032729753273e-09, -3.269803294680680e-07, -1.669114974637871e-07, -1.635604163152767e-07,
                    -1.634901647340340e-07, -1.634885961359928e-07, -1.634884647340340e-07, -1.634883647340338e-07,
                    -1.634882647340337e-07, -1.634881647340339e-07, -1.634880647340340e-07, -1.634879647340338e-07,
                    -1.634878647340341e-07, -1.634877647340340e-07, -1.634876647340340e-07, -1.634875647340339e-07,
                    -1.634874647340339e-07, -1.634873647340340e-07, -1.634872647340336e-07, -1.634871647340339e-07,
                    -1.634870647340340e-07, -1.634869647340340e-07, -1.634868647340339e-07, -1.634867647340339e-07,
                    -1.634866647340338e-07, -1.634865647340341e-07, -1.634864647340339e-07, -1.634863647340340e-07,
                    -1.634862647340338e-07, -1.634861647340339e-07, -1.634860647340339e-07, -1.634859647340338e-07,
                    -1.634858647340341e-07, -1.634857647340339e-07, -1.634856647340340e-07, -1.634855647340340e-07,
                    -1.634854647340339e-07, -1.634853647340342e-07, -1.634852647340340e-07, -1.634851647340339e-07,
                    -1.634850647340339e-07, -1.634849647340340e-07, -1.634848647340338e-07, -1.634847647340339e-07,
                    -1.634846647340337e-07, -1.634845647340338e-07, -1.634844647340339e-07, -1.634843647340339e-07,
                    -1.634842647340340e-07, -1.634841647340340e-07, -1.634840647340337e-07, -1.634839647340342e-07,
                    -1.561921753703778e-05, -7.973098933252920e-06, -7.813030101248643e-06, -7.809679020100136e-06,
                    -7.809608768518891e-06, -7.809607199920843e-06, -7.809607068518900e-06, -7.809606968518895e-06,
                    -7.809606868518890e-06, -7.809606768518885e-06, -7.809606668518894e-06, -7.809606568518889e-06,
                    -7.809606468518897e-06, -7.809606368518906e-06, -7.809606268518887e-06, -7.809606168518896e-06,
                    -7.809606068518891e-06, -7.809605968518899e-06, -7.809605868518894e-06, -7.809605768518889e-06,
                    -7.809605668518911e-06, -7.809605568518893e-06, -7.809605468518901e-06, -7.809605368518896e-06,
                    -7.809605268518905e-06, -7.809605168518900e-06, -7.809605068518895e-06, -7.809604968518890e-06,
                    -7.809604868518898e-06, -7.809604768518907e-06, -7.809604668518888e-06, -7.809604568518883e-06,
                    -7.809604468518878e-06, -7.809604368518887e-06, -7.809604268518895e-06, -7.809604168518890e-06,
                    -7.809604068518885e-06, -7.809603968518894e-06, -7.809603868518916e-06, -7.809603768518911e-06,
                    -7.809603668518892e-06, -7.809603568518901e-06, -7.809603468518909e-06, -7.809603368518904e-06,
                    -7.809603268518886e-06, -7.809603168518894e-06, -7.809603068518903e-06, -7.809602968518898e-06,
                    -7.809602868518906e-06, -7.809602768518901e-06, -7.809602668518910e-06, -7.460945259609771e-04,
                    -3.808568717490078e-04, -3.732107531452221e-04, -3.730506843132178e-04, -3.730473332320700e-04,
                    -3.730472629804886e-04, -3.730472614118900e-04, -3.730472612804882e-04, -3.730472611804892e-04,
                    -3.730472610804893e-04, -3.730472609804886e-04, -3.730472608804887e-04, -3.730472607804888e-04,
                    -3.730472606804890e-04, -3.730472605804891e-04, -3.730472604804884e-04, -3.730472603804885e-04,
                    -3.730472602804886e-04, -3.730472601804887e-04, -3.730472600804880e-04, -3.730472599804890e-04,
                    -3.730472598804891e-04, -3.730472597804893e-04, -3.730472596804885e-04, -3.730472595804887e-04,
                    -3.730472594804879e-04, -3.730472593804881e-04, -3.730472592804882e-04, -3.730472591804883e-04,
                    -3.730472590804884e-04, -3.730472589804886e-04, -3.730472588804887e-04, -3.730472587804888e-04,
                    -3.730472586804890e-04, -3.730472585804882e-04, -3.730472584804884e-04, -3.730472583804885e-04,
                    -3.730472582804886e-04, -3.730472581804879e-04, -3.730472580804889e-04, -3.730472579804881e-04,
                    -3.730472578804891e-04, -3.730472577804884e-04, -3.730472576804885e-04, -3.730472575804878e-04,
                    -3.730472574804888e-04, -3.730472573804889e-04, -3.730472572804891e-04, -3.730472571804892e-04,
                    -3.730472570804885e-04, -3.730472569804886e-04, -3.563923512166245e-02, -1.819266482381171e-02,
                    -1.782742716959979e-02, -1.781978105099596e-02, -1.781962098216400e-02, -1.781961763108281e-02,
                    -1.781961756083128e-02, -1.781961755926265e-02, -1.781961755913120e-02, -1.781961755903122e-02,
                    -1.781961755893124e-02, -1.781961755883127e-02, -1.781961755873124e-02, -1.781961755863121e-02,
                    -1.781961755853123e-02, -1.781961755843120e-02, -1.781961755833122e-02, -1.781961755823125e-02,
                    -1.781961755813122e-02, -1.781961755803124e-02, -1.781961755793127e-02, -1.781961755783124e-02,
                    -1.781961755773120e-02, -1.781961755763123e-02, -1.781961755753125e-02, -1.781961755743122e-02,
                    -1.781961755733125e-02, -1.781961755723122e-02, -1.781961755713124e-02, -1.781961755703121e-02,
                    -1.781961755693129e-02, -1.781961755683131e-02, -1.781961755673128e-02, -1.781961755663120e-02,
                    -1.781961755653122e-02, -1.781961755643119e-02, -1.781961755633121e-02, -1.781961755623124e-02,
                    -1.781961755613121e-02, -1.781961755603118e-02, -1.781961755593120e-02, -1.781961755583122e-02,
                    -1.781961755573119e-02, -1.781961755563127e-02, -1.781961755553124e-02, -1.781961755543127e-02,
                    -1.781961755533124e-02, -1.781961755523126e-02, -1.781961755513123e-02, -1.781961755503120e-02,
                    -1.781961755493128e-02, -1.702405033924435e+00, -8.690221345230462e-01, -8.515755642252003e-01,
                    -8.512103265709854e-01, -8.512026804523813e-01, -8.512025203835485e-01, -8.512025170324691e-01,
                    -8.512025169622177e-01, -8.512025169606474e-01, -8.512025169605160e-01, -8.512025169604129e-01,
                    -8.512025169603170e-01, -8.512025169602175e-01, -8.512025169601181e-01, -8.512025169600150e-01,
                    -8.512025169599191e-01, -8.512025169598161e-01, -8.512025169597166e-01, -8.512025169596171e-01,
                    -8.512025169595177e-01, -8.512025169594146e-01, -8.512025169593187e-01, -8.512025169592157e-01,
                    -8.512025169591197e-01, -8.512025169590167e-01, -8.512025169589172e-01, -8.512025169588142e-01,
                    -8.512025169587147e-01, -8.512025169586153e-01, -8.512025169585158e-01, -8.512025169584199e-01,
                    -8.512025169583168e-01, -8.512025169582174e-01, -8.512025169581143e-01, -8.512025169580149e-01,
                    -8.512025169579154e-01, -8.512025169578195e-01, -8.512025169577164e-01, -8.512025169576170e-01,
                    -8.512025169575175e-01, -8.512025169574180e-01, -8.512025169573185e-01, -8.512025169572155e-01,
                    -8.512025169571125e-01, -8.512025169570165e-01, -8.512025169569135e-01, -8.512025169568176e-01,
                    -8.512025169567181e-01, -8.512025169566151e-01, -8.512025169565156e-01, -8.512025169564197e-01,
                    -8.132000839795501e+01, -4.151120671593981e+01, -4.067782381653842e+01, -4.066037724624039e+01,
                    -4.066001200858614e+01, -4.066000436246759e+01, -4.066000420239880e+01, -4.066000419904753e+01,
                    -4.066000419897728e+01, -4.066000419897591e+01, -4.066000419897568e+01, -4.066000419897546e+01,
                    -4.066000419897546e+01, -4.066000419897546e+01, -4.066000419897523e+01, -4.066000419897523e+01,
                    -4.066000419897523e+01, -4.066000419897500e+01, -4.066000419897478e+01, -4.066000419897478e+01,
                    -4.066000419897478e+01, -4.066000419897455e+01, -4.066000419897455e+01, -4.066000419897455e+01,
                    -4.066000419897455e+01, -4.066000419897409e+01, -4.066000419897409e+01, -4.066000419897409e+01,
                    -4.066000419897387e+01, -4.066000419897387e+01, -4.066000419897364e+01, -4.066000419897341e+01,
                    -4.066000419897341e+01, -4.066000419897341e+01, -4.066000419897318e+01, -4.066000419897318e+01,
                    -4.066000419897318e+01, -4.066000419897296e+01, -4.066000419897296e+01, -4.066000419897296e+01,
                    -4.066000419897250e+01, -4.066000419897250e+01, -4.066000419897227e+01, -4.066000419897227e+01,
                    -4.066000419897227e+01, -4.066000419897205e+01, -4.066000419897205e+01, -4.066000419897182e+01,
                    -4.066000419897182e+01, -4.066000419897182e+01, -4.066000419897159e+01
                ],
                [
                    0.000000000000000e+00, -2.661394156859804e-05, -3.929388170000000e-05, -4.046503450000000e-05,
                    -4.046503460000000e-05, -4.046503469999999e-05, -4.046503479999999e-05, -4.046503490000000e-05,
                    -4.046503500000000e-05, -4.046503509999999e-05, -4.046503519999999e-05, -4.046503530000000e-05,
                    -4.046503540000000e-05, -4.046503549999999e-05, -4.046503560000000e-05, -4.046503570000000e-05,
                    -4.046503579999999e-05, -4.046503589999999e-05, -4.046503600000000e-05, -4.046503610000000e-05,
                    -4.046503619999999e-05, -4.046503629999999e-05, -4.046503640000000e-05, -4.046503650000000e-05,
                    -4.046503659999999e-05, -4.046503669999999e-05, -4.046503680000000e-05, -4.046503690000000e-05,
                    -4.046503699999999e-05, -4.046503709999999e-05, -4.046503720000000e-05, -4.046503730000000e-05,
                    -4.046503739999999e-05, -4.046503749999999e-05, -4.046503760000000e-05, -4.046503770000000e-05,
                    -4.046503779999999e-05, -4.046503789999999e-05, -4.046503800000000e-05, -4.046503810000000e-05,
                    -4.046503819999999e-05, -4.046503830000000e-05, -4.046503840000000e-05, -4.046503849999999e-05,
                    -4.046503859999999e-05, -4.046503870000000e-05, -4.046503880000000e-05, -4.046503889999999e-05,
                    -4.046503899999999e-05, -4.046503910000000e-05, -4.046503920000000e-05, 7.025158124305357e-11,
                    -4.054794000000000e-05, -6.716188156859803e-05, -7.984182169999999e-05, -8.101297450000000e-05,
                    -8.101297459999999e-05, -8.101297469999998e-05, -8.101297479999999e-05, -8.101297489999999e-05,
                    -8.101297500000000e-05, -8.101297509999997e-05, -8.101297519999999e-05, -8.101297529999998e-05,
                    -8.101297539999999e-05, -8.101297549999999e-05, -8.101297559999999e-05, -8.101297569999998e-05,
                    -8.101297579999998e-05, -8.101297589999999e-05, -8.101297599999999e-05, -8.101297609999998e-05,
                    -8.101297619999999e-05, -8.101297629999998e-05, -8.101297639999999e-05, -8.101297649999999e-05,
                    -8.101297660000000e-05, -8.101297669999999e-05, -8.101297679999999e-05, -8.101297689999998e-05,
                    -8.101297699999999e-05, -8.101297709999999e-05, -8.101297720000000e-05, -8.101297729999998e-05,
                    -8.101297739999998e-05, -8.101297749999999e-05, -8.101297759999999e-05, -8.101297769999998e-05,
                    -8.101297779999999e-05, -8.101297789999999e-05, -8.101297799999998e-05, -8.101297809999999e-05,
                    -8.101297819999999e-05, -8.101297829999999e-05, -8.101297839999998e-05, -8.101297849999998e-05,
                    -8.101297859999999e-05, -8.101297869999999e-05, -8.101297879999998e-05, -8.101297889999998e-05,
                    -8.101297899999998e-05, -8.101297909999999e-05, 3.421332729753273e-09, -5.448186974841875e-05,
                    -9.502987999999999e-05, -1.216438215685981e-04, -1.343237617000000e-04, -1.354949145000000e-04,
                    -1.354949146000000e-04, -1.354949147000000e-04, -1.354949148000000e-04, -1.354949149000000e-04,
                    -1.354949150000000e-04, -1.354949151000000e-04, -1.354949152000000e-04, -1.354949153000000e-04,
                    -1.354949154000000e-04, -1.354949155000000e-04, -1.354949156000000e-04, -1.354949157000000e-04,
                    -1.354949158000000e-04, -1.354949159000000e-04, -1.354949160000000e-04, -1.354949161000000e-04,
                    -1.354949162000000e-04, -1.354949163000000e-04, -1.354949164000000e-04, -1.354949165000000e-04,
                    -1.354949166000000e-04, -1.354949167000000e-04, -1.354949168000000e-04, -1.354949169000000e-04,
                    -1.354949170000000e-04, -1.354949171000000e-04, -1.354949172000000e-04, -1.354949173000000e-04,
                    -1.354949174000000e-04, -1.354949175000000e-04, -1.354949176000000e-04, -1.354949177000000e-04,
                    -1.354949178000000e-04, -1.354949179000000e-04, -1.354949180000000e-04, -1.354949181000000e-04,
                    -1.354949182000000e-04, -1.354949183000000e-04, -1.354949184000000e-04, -1.354949185000000e-04,
                    -1.354949186000000e-04, -1.354949187000000e-04, -1.354949188000000e-04, -1.354949189000000e-04,
                    -1.354949190000000e-04, 1.634901647340340e-07, -6.841251866727023e-05, -1.228978097484188e-04,
                    -1.634458200000000e-04, -1.900597615685981e-04, -2.027397017000000e-04, -2.039108545000000e-04,
                    -2.039108546000000e-04, -2.039108547000000e-04, -2.039108548000000e-04, -2.039108549000000e-04,
                    -2.039108550000000e-04, -2.039108551000000e-04, -2.039108552000000e-04, -2.039108553000000e-04,
                    -2.039108554000000e-04, -2.039108555000000e-04, -2.039108556000000e-04, -2.039108557000000e-04,
                    -2.039108558000000e-04, -2.039108559000000e-04, -2.039108560000000e-04, -2.039108561000000e-04,
                    -2.039108562000000e-04, -2.039108563000000e-04, -2.039108564000000e-04, -2.039108565000000e-04,
                    -2.039108566000000e-04, -2.039108567000000e-04, -2.039108568000000e-04, -2.039108569000000e-04,
                    -2.039108570000000e-04, -2.039108571000000e-04, -2.039108572000000e-04, -2.039108573000000e-04,
                    -2.039108574000000e-04, -2.039108575000000e-04, -2.039108576000000e-04, -2.039108577000000e-04,
                    -2.039108578000000e-04, -2.039108579000000e-04, -2.039108580000000e-04, -2.039108581000000e-04,
                    -2.039108582000000e-04, -2.039108583000000e-04, -2.039108584000000e-04, -2.039108585000000e-04,
                    -2.039108586000000e-04, -2.039108587000000e-04, -2.039108588000000e-04, -2.039108589000000e-04,
                    7.809608768518891e-06, -8.218644983526598e-05, -1.507624586672703e-04, -2.052477497484188e-04,
                    -2.457957600000000e-04, -2.724097015685980e-04, -2.850896417000000e-04, -2.862607945000000e-04,
                    -2.862607945999999e-04, -2.862607947000000e-04, -2.862607947999999e-04, -2.862607949000000e-04,
                    -2.862607950000000e-04, -2.862607951000000e-04, -2.862607952000000e-04, -2.862607952999999e-04,
                    -2.862607954000000e-04, -2.862607955000000e-04, -2.862607956000000e-04, -2.862607957000000e-04,
                    -2.862607957999999e-04, -2.862607959000000e-04, -2.862607960000000e-04, -2.862607960999999e-04,
                    -2.862607962000000e-04, -2.862607963000000e-04, -2.862607964000000e-04, -2.862607964999999e-04,
                    -2.862607965999999e-04, -2.862607967000000e-04, -2.862607967999999e-04, -2.862607968999999e-04,
                    -2.862607970000000e-04, -2.862607970999999e-04, -2.862607972000000e-04, -2.862607973000000e-04,
                    -2.862607973999999e-04, -2.862607975000000e-04, -2.862607975999999e-04, -2.862607977000000e-04,
                    -2.862607978000000e-04, -2.862607979000000e-04, -2.862607979999999e-04, -2.862607980999999e-04,
                    -2.862607982000000e-04, -2.862607983000000e-04, -2.862607984000000e-04, -2.862607984999999e-04,
                    -2.862607986000000e-04, -2.862607987000000e-04, -2.862607988000000e-04, 3.730472629804886e-04,
                    -8.847433123148111e-05, -1.784703898352660e-04, -2.470463986672703e-04, -3.015316897484187e-04,
                    -3.420797000000000e-04, -3.686936415685981e-04, -3.813735817000000e-04, -3.825447345000001e-04,
                    -3.825447346000000e-04, -3.825447347000000e-04, -3.825447348000000e-04, -3.825447349000001e-04,
                    -3.825447350000001e-04, -3.825447351000000e-04, -3.825447352000000e-04, -3.825447353000000e-04,
                    -3.825447354000000e-04, -3.825447355000001e-04, -3.825447356000000e-04, -3.825447357000000e-04,
                    -3.825447358000000e-04, -3.825447359000000e-04, -3.825447360000000e-04, -3.825447361000000e-04,
                    -3.825447362000000e-04, -3.825447363000001e-04, -3.825447364000001e-04, -3.825447365000001e-04,
                    -3.825447366000000e-04, -3.825447367000000e-04, -3.825447368000000e-04, -3.825447369000000e-04,
                    -3.825447370000001e-04, -3.825447371000000e-04, -3.825447372000000e-04, -3.825447373000000e-04,
                    -3.825447374000000e-04, -3.825447375000001e-04, -3.825447376000000e-04, -3.825447377000000e-04,
                    -3.825447378000000e-04, -3.825447379000001e-04, -3.825447380000000e-04, -3.825447381000001e-04,
                    -3.825447382000001e-04, -3.825447383000001e-04, -3.825447384000000e-04, -3.825447385000000e-04,
                    -3.825447386000000e-04, -3.825447387000000e-04, 1.781961756083122e-02, 2.628293229804887e-04,
                    -1.986922712314811e-04, -2.886883298352659e-04, -3.572643386672703e-04, -4.117496297484188e-04,
                    -4.522976399999999e-04, -4.789115815685980e-04, -4.915915216999999e-04, -4.927626745000000e-04,
                    -4.927626746000000e-04, -4.927626747000001e-04, -4.927626748000001e-04, -4.927626749000000e-04,
                    -4.927626750000000e-04, -4.927626751000001e-04, -4.927626752000000e-04, -4.927626753000001e-04,
                    -4.927626754000000e-04, -4.927626755000000e-04, -4.927626756000001e-04, -4.927626757000000e-04,
                    -4.927626757999999e-04, -4.927626758999999e-04, -4.927626760000000e-04, -4.927626761000000e-04,
                    -4.927626762000000e-04, -4.927626763000000e-04, -4.927626764000001e-04, -4.927626765000000e-04,
                    -4.927626766000000e-04, -4.927626767000000e-04, -4.927626768000000e-04, -4.927626769000000e-04,
                    -4.927626770000000e-04, -4.927626771000000e-04, -4.927626772000001e-04, -4.927626773000000e-04,
                    -4.927626774000000e-04, -4.927626775000000e-04, -4.927626776000001e-04, -4.927626777000001e-04,
                    -4.927626778000000e-04, -4.927626779000001e-04, -4.927626780000001e-04, -4.927626781000001e-04,
                    -4.927626782000001e-04, -4.927626783000000e-04, -4.927626784000000e-04, -4.927626785000000e-04,
                    -4.927626786000000e-04, 8.512025169622177e-01, 1.769546562083119e-02, 1.386773829804878e-04,
                    -3.228442112314812e-04, -4.128402698352659e-04, -4.814162786672702e-04, -5.359015697484187e-04,
                    -5.764495799999998e-04, -6.030635215685978e-04, -6.157434617000000e-04, -6.169146144999999e-04,
                    -6.169146145999999e-04, -6.169146147000000e-04, -6.169146148000000e-04, -6.169146148999999e-04,
                    -6.169146150000000e-04, -6.169146151000000e-04, -6.169146151999999e-04, -6.169146152999998e-04,
                    -6.169146153999999e-04, -6.169146155000000e-04, -6.169146155999999e-04, -6.169146157000000e-04,
                    -6.169146157999998e-04, -6.169146158999999e-04, -6.169146159999998e-04, -6.169146160999999e-04,
                    -6.169146161999999e-04, -6.169146163000001e-04, -6.169146164000000e-04, -6.169146165000000e-04,
                    -6.169146165999999e-04, -6.169146166999999e-04, -6.169146167999999e-04, -6.169146168999999e-04,
                    -6.169146170000000e-04, -6.169146170999999e-04, -6.169146172000000e-04, -6.169146172999999e-04,
                    -6.169146173999999e-04, -6.169146175000000e-04, -6.169146175999999e-04, -6.169146176999999e-04,
                    -6.169146177999999e-04, -6.169146178999999e-04, -6.169146180000000e-04, -6.169146181000000e-04,
                    -6.169146182000000e-04, -6.169146182999999e-04, -6.169146183999999e-04, -6.169146184999999e-04,
                    4.066000419897750e+01, 8.510644310222162e-01, 1.755737968083126e-02, 5.914429804868004e-07,
                    -4.609301512314812e-04, -5.509262098352660e-04, -6.195022186672701e-04, -6.739875097484187e-04,
                    -7.145355199999997e-04, -7.411494615685979e-04, -7.538294016999999e-04, -7.550005544999998e-04,
                    -7.550005545999999e-04, -7.550005546999999e-04, -7.550005547999998e-04, -7.550005548999999e-04,
                    -7.550005550000000e-04, -7.550005551000000e-04, -7.550005551999998e-04, -7.550005552999998e-04,
                    -7.550005553999998e-04, -7.550005555000000e-04, -7.550005556000000e-04, -7.550005556999999e-04,
                    -7.550005557999999e-04, -7.550005558999997e-04, -7.550005559999999e-04, -7.550005560999997e-04,
                    -7.550005561999997e-04, -7.550005563000000e-04, -7.550005564000001e-04, -7.550005565000000e-04,
                    -7.550005565999998e-04, -7.550005566999999e-04, -7.550005567999999e-04, -7.550005568999999e-04,
                    -7.550005570000000e-04, -7.550005570999998e-04, -7.550005571999999e-04, -7.550005573000000e-04,
                    -7.550005573999999e-04, -7.550005575000000e-04, -7.550005576000001e-04, -7.550005576999999e-04,
                    -7.550005578000000e-04, -7.550005579000000e-04, -7.550005580000000e-04, -7.550005580999998e-04,
                    -7.550005581999999e-04, -7.550005583000000e-04, -7.550005583999999e-04
                ]
            ];

            // Analyze
            AnalyzeDC(dc, ckt, exports, references);
            DestroyExports(exports);
        }

        [Test]
        public void When_SimpleSmallSignal_Expect_Reference()
        {
            // Build the circuit
            var ckt = new Circuit(
                new VoltageSource("V1", "g", "0", 0.5)
                    .SetParameter("acmag", 1.0),
                new VoltageSource("V2", "d", "0", 2.0),
                CreateJFET("J1", "d", "g", "0", "JX"),
                CreateJFETModel("JX", "IS=1.500E-12 BETA=696.7E-6 VTO=-0.241 CGS=1e-12 CGD=5e-12")
            );

            // Create the simulation
            var ac = new AC("ac", new DecadeSweep(0.1, 10e9, 10));

            // Create exports
            var exports = new IExport<Complex>[]
            {
                new ComplexPropertyExport(ac, "V1", "i"),
                new ComplexPropertyExport(ac, "V2", "i"),
            };

            // Create references
            double[] r1 =
            [
                -1.442331332258340e-02, -2.875494240790893e-12, -1.442331332258340e-02, -3.620032771199431e-12,
                -1.442331332258340e-02, -4.557351247190625e-12, -1.442331332258340e-02, -5.737365295560120e-12,
                -1.442331332258340e-02, -7.222914967326588e-12, -1.442331332258340e-02, -9.093111199595878e-12,
                -1.442331332258340e-02, -1.144754876144140e-11, -1.442331332258340e-02, -1.441161003853142e-11,
                -1.442331332258340e-02, -1.814314210237512e-11, -1.442331332258340e-02, -2.284086264247269e-11,
                -1.442331332258340e-02, -2.875494240790895e-11, -1.442331332258340e-02, -3.620032771199434e-11,
                -1.442331332258340e-02, -4.557351247190628e-11, -1.442331332258340e-02, -5.737365295560124e-11,
                -1.442331332258340e-02, -7.222914967326591e-11, -1.442331332258340e-02, -9.093111199595883e-11,
                -1.442331332258340e-02, -1.144754876144140e-10, -1.442331332258340e-02, -1.441161003853143e-10,
                -1.442331332258340e-02, -1.814314210237513e-10, -1.442331332258340e-02, -2.284086264247271e-10,
                -1.442331332258340e-02, -2.875494240790896e-10, -1.442331332258340e-02, -3.620032771199436e-10,
                -1.442331332258340e-02, -4.557351247190631e-10, -1.442331332258340e-02, -5.737365295560126e-10,
                -1.442331332258340e-02, -7.222914967326596e-10, -1.442331332258340e-02, -9.093111199595889e-10,
                -1.442331332258340e-02, -1.144754876144141e-09, -1.442331332258340e-02, -1.441161003853143e-09,
                -1.442331332258340e-02, -1.814314210237514e-09, -1.442331332258340e-02, -2.284086264247272e-09,
                -1.442331332258340e-02, -2.875494240790898e-09, -1.442331332258340e-02, -3.620032771199437e-09,
                -1.442331332258340e-02, -4.557351247190633e-09, -1.442331332258340e-02, -5.737365295560129e-09,
                -1.442331332258340e-02, -7.222914967326600e-09, -1.442331332258340e-02, -9.093111199595894e-09,
                -1.442331332258340e-02, -1.144754876144142e-08, -1.442331332258340e-02, -1.441161003853144e-08,
                -1.442331332258340e-02, -1.814314210237515e-08, -1.442331332258340e-02, -2.284086264247273e-08,
                -1.442331332258340e-02, -2.875494240790899e-08, -1.442331332258340e-02, -3.620032771199439e-08,
                -1.442331332258340e-02, -4.557351247190635e-08, -1.442331332258340e-02, -5.737365295560131e-08,
                -1.442331332258340e-02, -7.222914967326603e-08, -1.442331332258340e-02, -9.093111199595897e-08,
                -1.442331332258340e-02, -1.144754876144142e-07, -1.442331332258340e-02, -1.441161003853145e-07,
                -1.442331332258340e-02, -1.814314210237516e-07, -1.442331332258340e-02, -2.284086264247274e-07,
                -1.442331332258340e-02, -2.875494240790900e-07, -1.442331332258340e-02, -3.620032771199442e-07,
                -1.442331332258340e-02, -4.557351247190637e-07, -1.442331332258340e-02, -5.737365295560135e-07,
                -1.442331332258340e-02, -7.222914967326608e-07, -1.442331332258340e-02, -9.093111199595903e-07,
                -1.442331332258340e-02, -1.144754876144143e-06, -1.442331332258340e-02, -1.441161003853146e-06,
                -1.442331332258340e-02, -1.814314210237517e-06, -1.442331332258340e-02, -2.284086264247276e-06,
                -1.442331332258340e-02, -2.875494240790903e-06, -1.442331332258340e-02, -3.620032771199444e-06,
                -1.442331332258340e-02, -4.557351247190640e-06, -1.442331332258340e-02, -5.737365295560139e-06,
                -1.442331332258340e-02, -7.222914967326613e-06, -1.442331332258340e-02, -9.093111199595910e-06,
                -1.442331332258340e-02, -1.144754876144144e-05, -1.442331332258340e-02, -1.441161003853147e-05,
                -1.442331332258340e-02, -1.814314210237519e-05, -1.442331332258340e-02, -2.284086264247278e-05,
                -1.442331332258340e-02, -2.875494240790905e-05, -1.442331332258340e-02, -3.620032771199446e-05,
                -1.442331332258340e-02, -4.557351247190644e-05, -1.442331332258340e-02, -5.737365295560142e-05,
                -1.442331332258340e-02, -7.222914967326616e-05, -1.442331332258340e-02, -9.093111199595915e-05,
                -1.442331332258340e-02, -1.144754876144144e-04, -1.442331332258340e-02, -1.441161003853148e-04,
                -1.442331332258340e-02, -1.814314210237520e-04, -1.442331332258340e-02, -2.284086264247279e-04,
                -1.442331332258340e-02, -2.875494240790906e-04, -1.442331332258340e-02, -3.620032771199449e-04,
                -1.442331332258340e-02, -4.557351247190646e-04, -1.442331332258340e-02, -5.737365295560146e-04,
                -1.442331332258340e-02, -7.222914967326621e-04, -1.442331332258340e-02, -9.093111199595921e-04,
                -1.442331332258340e-02, -1.144754876144145e-03, -1.442331332258340e-02, -1.441161003853149e-03,
                -1.442331332258340e-02, -1.814314210237521e-03, -1.442331332258340e-02, -2.284086264247280e-03,
                -1.442331332258340e-02, -2.875494240790908e-03, -1.442331332258340e-02, -3.620032771199451e-03,
                -1.442331332258340e-02, -4.557351247190649e-03, -1.442331332258340e-02, -5.737365295560150e-03,
                -1.442331332258340e-02, -7.222914967326626e-03, -1.442331332258340e-02, -9.093111199595928e-03,
                -1.442331332258340e-02, -1.144754876144146e-02, -1.442331332258340e-02, -1.441161003853149e-02,
                -1.442331332258340e-02, -1.814314210237522e-02, -1.442331332258340e-02, -2.284086264247281e-02,
                -1.442331332258340e-02, -2.875494240790910e-02, -1.442331332258340e-02, -3.620032771199453e-02,
                -1.442331332258340e-02, -4.557351247190652e-02, -1.442331332258340e-02, -5.737365295560154e-02,
                -1.442331332258340e-02, -7.222914967326631e-02, -1.442331332258340e-02, -9.093111199595932e-02,
                -1.442331332258340e-02, -1.144754876144146e-01, -1.442331332258340e-02, -1.441161003853151e-01,
                -1.442331332258340e-02, -1.814314210237523e-01, -1.442331332258340e-02, -2.284086264247283e-01,
                -1.442331332258340e-02, -2.875494240790912e-01
            ];
            double[] r2 =
            [
                -1.032509398000000e-03, 1.986917653159220e-12, -1.032509398000000e-03, 2.501381124704572e-12,
                -1.032509398000000e-03, 3.149052262472860e-12, -1.032509398000000e-03, 3.964421916294999e-12,
                -1.032509398000000e-03, 4.990911493497504e-12, -1.032509398000000e-03, 6.283185307179588e-12,
                -1.032509398000000e-03, 7.910061650220124e-12, -1.032509398000000e-03, 9.958177620320621e-12,
                -1.032509398000000e-03, 1.253660286138160e-11, -1.032509398000000e-03, 1.578264791976476e-11,
                -1.032509398000000e-03, 1.986917653159221e-11, -1.032509398000000e-03, 2.501381124704573e-11,
                -1.032509398000000e-03, 3.149052262472862e-11, -1.032509398000000e-03, 3.964421916295002e-11,
                -1.032509398000000e-03, 4.990911493497507e-11, -1.032509398000000e-03, 6.283185307179591e-11,
                -1.032509398000000e-03, 7.910061650220129e-11, -1.032509398000000e-03, 9.958177620320626e-11,
                -1.032509398000000e-03, 1.253660286138161e-10, -1.032509398000000e-03, 1.578264791976477e-10,
                -1.032509398000000e-03, 1.986917653159222e-10, -1.032509398000000e-03, 2.501381124704574e-10,
                -1.032509398000000e-03, 3.149052262472864e-10, -1.032509398000000e-03, 3.964421916295004e-10,
                -1.032509398000000e-03, 4.990911493497510e-10, -1.032509398000000e-03, 6.283185307179595e-10,
                -1.032509398000000e-03, 7.910061650220133e-10, -1.032509398000000e-03, 9.958177620320630e-10,
                -1.032509398000000e-03, 1.253660286138161e-09, -1.032509398000000e-03, 1.578264791976478e-09,
                -1.032509398000000e-03, 1.986917653159223e-09, -1.032509398000000e-03, 2.501381124704576e-09,
                -1.032509398000000e-03, 3.149052262472865e-09, -1.032509398000000e-03, 3.964421916295006e-09,
                -1.032509398000000e-03, 4.990911493497512e-09, -1.032509398000000e-03, 6.283185307179598e-09,
                -1.032509398000000e-03, 7.910061650220138e-09, -1.032509398000000e-03, 9.958177620320636e-09,
                -1.032509398000000e-03, 1.253660286138162e-08, -1.032509398000000e-03, 1.578264791976479e-08,
                -1.032509398000000e-03, 1.986917653159224e-08, -1.032509398000000e-03, 2.501381124704577e-08,
                -1.032509398000000e-03, 3.149052262472867e-08, -1.032509398000000e-03, 3.964421916295008e-08,
                -1.032509398000000e-03, 4.990911493497515e-08, -1.032509398000000e-03, 6.283185307179601e-08,
                -1.032509398000000e-03, 7.910061650220140e-08, -1.032509398000000e-03, 9.958177620320639e-08,
                -1.032509398000000e-03, 1.253660286138162e-07, -1.032509398000000e-03, 1.578264791976479e-07,
                -1.032509398000000e-03, 1.986917653159225e-07, -1.032509398000000e-03, 2.501381124704578e-07,
                -1.032509398000000e-03, 3.149052262472869e-07, -1.032509398000000e-03, 3.964421916295010e-07,
                -1.032509398000000e-03, 4.990911493497518e-07, -1.032509398000000e-03, 6.283185307179604e-07,
                -1.032509398000000e-03, 7.910061650220145e-07, -1.032509398000000e-03, 9.958177620320648e-07,
                -1.032509398000000e-03, 1.253660286138163e-06, -1.032509398000000e-03, 1.578264791976481e-06,
                -1.032509398000000e-03, 1.986917653159226e-06, -1.032509398000000e-03, 2.501381124704580e-06,
                -1.032509398000000e-03, 3.149052262472871e-06, -1.032509398000000e-03, 3.964421916295013e-06,
                -1.032509398000000e-03, 4.990911493497522e-06, -1.032509398000000e-03, 6.283185307179610e-06,
                -1.032509398000000e-03, 7.910061650220152e-06, -1.032509398000000e-03, 9.958177620320655e-06,
                -1.032509398000000e-03, 1.253660286138164e-05, -1.032509398000000e-03, 1.578264791976482e-05,
                -1.032509398000000e-03, 1.986917653159228e-05, -1.032509398000000e-03, 2.501381124704582e-05,
                -1.032509398000000e-03, 3.149052262472873e-05, -1.032509398000000e-03, 3.964421916295015e-05,
                -1.032509398000000e-03, 4.990911493497524e-05, -1.032509398000000e-03, 6.283185307179613e-05,
                -1.032509398000000e-03, 7.910061650220157e-05, -1.032509398000000e-03, 9.958177620320662e-05,
                -1.032509398000000e-03, 1.253660286138165e-04, -1.032509398000000e-03, 1.578264791976483e-04,
                -1.032509398000000e-03, 1.986917653159229e-04, -1.032509398000000e-03, 2.501381124704584e-04,
                -1.032509398000000e-03, 3.149052262472875e-04, -1.032509398000000e-03, 3.964421916295018e-04,
                -1.032509398000000e-03, 4.990911493497527e-04, -1.032509398000000e-03, 6.283185307179617e-04,
                -1.032509398000000e-03, 7.910061650220160e-04, -1.032509398000000e-03, 9.958177620320668e-04,
                -1.032509398000000e-03, 1.253660286138166e-03, -1.032509398000000e-03, 1.578264791976484e-03,
                -1.032509398000000e-03, 1.986917653159231e-03, -1.032509398000000e-03, 2.501381124704585e-03,
                -1.032509398000000e-03, 3.149052262472877e-03, -1.032509398000000e-03, 3.964421916295021e-03,
                -1.032509398000000e-03, 4.990911493497531e-03, -1.032509398000000e-03, 6.283185307179621e-03,
                -1.032509398000000e-03, 7.910061650220165e-03, -1.032509398000000e-03, 9.958177620320672e-03,
                -1.032509398000000e-03, 1.253660286138166e-02, -1.032509398000000e-03, 1.578264791976485e-02,
                -1.032509398000000e-03, 1.986917653159232e-02, -1.032509398000000e-03, 2.501381124704586e-02,
                -1.032509398000000e-03, 3.149052262472879e-02, -1.032509398000000e-03, 3.964421916295023e-02,
                -1.032509398000000e-03, 4.990911493497534e-02, -1.032509398000000e-03, 6.283185307179624e-02,
                -1.032509398000000e-03, 7.910061650220171e-02, -1.032509398000000e-03, 9.958177620320680e-02,
                -1.032509398000000e-03, 1.253660286138167e-01, -1.032509398000000e-03, 1.578264791976486e-01,
                -1.032509398000000e-03, 1.986917653159233e-01,
            ];
            var references = new[]
            {
                new Complex[r1.Length / 2],
                new Complex[r2.Length / 2]
            };
            for (int i = 0; i < r1.Length / 2; i++)
            {
                references[0][i] = new Complex(r1[i * 2], r1[i * 2 + 1]);
                references[1][i] = new Complex(r2[i * 2], r2[i * 2 + 1]);
            }

            // Analyze
            AnalyzeAC(ac, ckt, exports, references);
            DestroyExports(exports);
        }

        [Test]
        public void When_SimpleTransient_Expect_Reference()
        {
            // Build the circuit
            var ckt = new Circuit(
                new VoltageSource("V1", "g", "0", new Pulse(0, 0.7, 1e-9, 1e-7, 1e-7, 1e-6, 2e-6)),
                new VoltageSource("V2", "d", "0", 2.0),
                CreateJFET("J1", "d", "g", "0", "JX"),
                CreateJFETModel("JX", "IS=1.500E-12 BETA=696.7E-6 VTO=-0.241 CGS=1e-12 CGD=5e-12")
            );

            // Build the simulation
            var tran = new Transient("tran", 1e-6, 10e-6);

            // Build the exports
            var exports = new IExport<double>[]
            {
                new GenericExport<double>(tran, () => tran.GetState<IIntegrationMethod>().Time),
                new RealPropertyExport(tran, "V1", "i"),
                new RealPropertyExport(tran, "V2", "i")
            };

            // Build the references
            // NOTE: This reference was created while specifying ITL4=100. Spice 3f5 limits junction voltage change from
            // one iteration to the next to avoid the dreaded exponential problems. The first iteration uses an "old value"
            // that is the value of several timepoints ago, instead of using the real "last iteration" value.
            // Spice# does not have this, it will always start from the real "last iteration" value, so it converges faster!
            // There was an edge case where Spice 3f5 could not reach convergence due to this, causing the timepoints to be
            // different. Hence ITL4 (number of transient iterations) was set to 100 to avoid this in Spice 3f5.
            double[][] references =
            [
                [
                    0.000000000000000e+00, 1.000000000000000e-11, 2.000000000000000e-11, 4.000000000000000e-11,
                    8.000000000000001e-11, 1.600000000000000e-10, 3.200000000000000e-10, 6.400000000000001e-10,
                    1.000000000000000e-09, 1.064000000000000e-09, 1.192000000000000e-09, 1.448000000000000e-09,
                    1.960000000000000e-09, 2.984000000000000e-09, 5.032000000000000e-09, 9.128000000000001e-09,
                    1.732000000000000e-08, 3.370400000000001e-08, 6.647200000000001e-08, 1.010000000000000e-07,
                    1.075536000000000e-07, 1.206608000000000e-07, 1.468752000000000e-07, 1.993040000000000e-07,
                    3.041616000000000e-07, 5.041616000000000e-07, 7.041616000000000e-07, 9.041616000000000e-07,
                    1.101000000000000e-06, 1.111000000000000e-06, 1.131000000000000e-06, 1.171000000000000e-06,
                    1.201000000000000e-06, 1.201488896505087e-06, 1.202466689515262e-06, 1.204422275535611e-06,
                    1.208333447576309e-06, 1.216155791657705e-06, 1.231800479820498e-06, 1.263089856146083e-06,
                    1.325668608797254e-06, 1.450826114099595e-06, 1.650826114099595e-06, 1.850826114099595e-06,
                    2.001000000000000e-06, 2.003242749042593e-06, 2.007728247127780e-06, 2.016699243298153e-06,
                    2.034641235638898e-06, 2.070525220320391e-06, 2.101000000000000e-06, 2.107086411514326e-06,
                    2.119259234542978e-06, 2.143604880600283e-06, 2.192296172714891e-06, 2.289678756944109e-06,
                    2.484443925402543e-06, 2.684443925402543e-06, 2.884443925402543e-06, 3.084443925402543e-06,
                    3.101000000000000e-06, 3.103891368699244e-06, 3.109674106097733e-06, 3.121239580894711e-06,
                    3.144370530488668e-06, 3.190632429676581e-06, 3.201000000000000e-06, 3.201254718068481e-06,
                    3.201764154205445e-06, 3.202783026479372e-06, 3.204820771027225e-06, 3.208896260122932e-06,
                    3.217047238314347e-06, 3.233349194697175e-06, 3.265953107462833e-06, 3.331160932994149e-06,
                    3.461576584056780e-06, 3.661576584056780e-06, 3.861576584056779e-06, 4.000999999999999e-06,
                    4.003092221345344e-06, 4.007276664036034e-06, 4.015645549417414e-06, 4.032383320180173e-06,
                    4.065858861705691e-06, 4.100999999999999e-06, 4.107695108305103e-06, 4.121085324915311e-06,
                    4.147865758135725e-06, 4.201426624576555e-06, 4.308548357458215e-06, 4.508548357458214e-06,
                    4.708548357458214e-06, 4.908548357458214e-06, 5.100999999999999e-06, 5.110999999999999e-06,
                    5.130999999999999e-06, 5.170999999999998e-06, 5.200999999999999e-06, 5.201488896505086e-06,
                    5.202466689515261e-06, 5.204422275535610e-06, 5.208333447576309e-06, 5.216155791657706e-06,
                    5.231800479820501e-06, 5.263089856146090e-06, 5.325668608797269e-06, 5.450826114099627e-06,
                    5.650826114099627e-06, 5.850826114099627e-06, 6.000999999999999e-06, 6.003242749042592e-06,
                    6.007728247127777e-06, 6.016699243298148e-06, 6.034641235638890e-06, 6.070525220320374e-06,
                    6.101000000000000e-06, 6.107086411514330e-06, 6.119259234542990e-06, 6.143604880600310e-06,
                    6.192296172714950e-06, 6.289678756944231e-06, 6.484443925402791e-06, 6.684443925402791e-06,
                    6.884443925402791e-06, 7.084443925402791e-06, 7.100999999999999e-06, 7.103891368699217e-06,
                    7.109674106097652e-06, 7.121239580894522e-06, 7.144370530488263e-06, 7.190632429675743e-06,
                    7.200999999999999e-06, 7.201254718068493e-06, 7.201764154205481e-06, 7.202783026479458e-06,
                    7.204820771027411e-06, 7.208896260123316e-06, 7.217047238315128e-06, 7.233349194698750e-06,
                    7.265953107465994e-06, 7.331160933000483e-06, 7.461576584069460e-06, 7.661576584069460e-06,
                    7.861576584069460e-06, 8.001000000000000e-06, 8.003092221345167e-06, 8.007276664035502e-06,
                    8.015645549416171e-06, 8.032383320177510e-06, 8.065858861700189e-06, 8.101000000000001e-06,
                    8.107695108304536e-06, 8.121085324913607e-06, 8.147865758131750e-06, 8.201426624568035e-06,
                    8.308548357440604e-06, 8.508548357440604e-06, 8.708548357440603e-06, 8.908548357440603e-06,
                    9.101000000000001e-06, 9.111000000000001e-06, 9.131000000000001e-06, 9.171000000000001e-06,
                    9.201000000000002e-06, 9.201488896505089e-06, 9.202466689515264e-06, 9.204422275535613e-06,
                    9.208333447576311e-06, 9.216155791657706e-06, 9.231800479820497e-06, 9.263089856146081e-06,
                    9.325668608797249e-06, 9.450826114099584e-06, 9.650826114099584e-06, 9.850826114099583e-06,
                    9.999999999999999e-06
                ],
                [
                    3.500000000000000e-12, 3.499978085130806e-12, 3.499978085130806e-12, 3.499978085130806e-12,
                    3.499978085130806e-12, 3.500005840706422e-12, 3.500005840706422e-12, 3.499998901812518e-12,
                    3.499998901812518e-12, -2.720879458507813e-05, -2.721803063769949e-05, -2.722728628550236e-05,
                    -2.725509248074364e-05, -2.730172599242417e-05, -2.740525436966539e-05, -2.760733353206240e-05,
                    -2.803898386555415e-05, -2.898698769225873e-05, -1.057396086346378e-04, -8.512375602481264e-01,
                    -8.512025169594253e-01, -8.512025169594253e-01, -8.512025169594253e-01, -8.512025169594217e-01,
                    -8.512025169594253e-01, -8.512025169594217e-01, -8.512025169594217e-01, -8.512025169594217e-01,
                    -8.512025169594217e-01, -5.680355486321775e-02, -2.220592870521990e-04, 2.911204040254152e-05,
                    2.685466974566809e-05, 3.500000636535994e-12, 3.500000636535994e-12, 3.499999769174256e-12,
                    3.500000202855125e-12, 3.499999986014690e-12, 3.499999986014690e-12, 3.499999986014690e-12,
                    3.500000013119745e-12, 3.499999999567217e-12, 3.499999999567217e-12, 3.499999999567217e-12,
                    3.499999999567217e-12, -2.726145463491448e-05, -2.759194722126986e-05, -2.794881831155896e-05,
                    -2.910091430149813e-05, -2.544831755743309e-04, -8.512376808428179e-01, -8.512025169594217e-01,
                    -8.512025169594217e-01, -8.512025169594217e-01, -8.512025169594253e-01, -8.512025169594217e-01,
                    -8.512025169594182e-01, -8.512025169594217e-01, -8.512025169594217e-01, -8.512025169594217e-01,
                    -8.512025169594217e-01, -3.891744039512091e-01, -8.133969361708027e-02, -3.523980377396901e-03,
                    2.366931753665651e-05, 2.773774949484637e-05, 2.718783455308613e-05, 3.500044004622893e-12,
                    3.499953799002142e-12, 3.500047474069845e-12, 3.499953799002142e-12, 3.500046173027238e-12,
                    3.499954015842577e-12, 3.500046064607021e-12, 3.499953961632468e-12, 3.500046064607021e-12,
                    3.499953961632468e-12, 3.500046044278230e-12, 3.499953954856205e-12, 3.500046037501967e-12,
                    -2.725779880547012e-05, -2.756565784954078e-05, -2.789631100237661e-05, -2.895331932028849e-05,
                    -9.425096827012178e-05, -8.512376101408172e-01, -8.512025169594182e-01, -8.512025169594182e-01,
                    -8.512025169594217e-01, -8.512025169594217e-01, -8.512025169594217e-01, -8.512025169594217e-01,
                    -8.512025169594217e-01, -8.512025169594217e-01, -8.512025169594217e-01, -5.680355486322397e-02,
                    -2.220592870522415e-04, 2.911204040254058e-05, 2.685466974566909e-05, 3.500024922664657e-12,
                    3.499976350407330e-12, 3.500024922664657e-12, 3.499975049364723e-12, 3.500025139505092e-12,
                    3.499974940944506e-12, 3.500025031084875e-12, 3.499974940944506e-12, 3.500025071742456e-12,
                    3.499974934168242e-12, 3.500025064966193e-12, 3.499974927391979e-12, -2.726145463490460e-05,
                    -2.759194722128017e-05, -2.794881831154660e-05, -2.910091430150902e-05, -2.544831755733456e-04,
                    -8.512376808428179e-01, -8.512025169594217e-01, -8.512025169594217e-01, -8.512025169594217e-01,
                    -8.512025169594253e-01, -8.512025169594217e-01, -8.512025169594182e-01, -8.512025169594217e-01,
                    -8.512025169594217e-01, -8.512025169594217e-01, -8.512025169594253e-01, -3.891744039540210e-01,
                    -8.133969361885263e-02, -3.523980377578756e-03, 2.366931753594988e-05, 2.773774949488553e-05,
                    2.718783455308895e-05, 3.500044004622893e-12, 3.499953799002142e-12, 3.500047474069845e-12,
                    3.499953799002142e-12, 3.500046173027238e-12, 3.499954015842577e-12, 3.500046064607021e-12,
                    3.499953961632468e-12, 3.500046064607021e-12, 3.499953961632468e-12, 3.500046044278230e-12,
                    3.499953954856205e-12, 3.500046037501967e-12, -2.725779880546058e-05, -2.756565784951870e-05,
                    -2.789631100230227e-05, -2.895331932013338e-05, -9.425096817577017e-05, -8.512376101408456e-01,
                    -8.512025169594217e-01, -8.512025169594217e-01, -8.512025169594217e-01, -8.512025169594182e-01,
                    -8.512025169594217e-01, -8.512025169594217e-01, -8.512025169594217e-01, -8.512025169594217e-01,
                    -8.512025169591304e-01, -5.680355486319799e-02, -2.220592870521279e-04, 2.911204040254169e-05,
                    2.685466974566402e-05, 3.500000636535994e-12, 3.500000636535994e-12, 3.499999769174256e-12,
                    3.500000202855125e-12, 3.499999986014690e-12, 3.499999986014690e-12, 3.499999986014690e-12,
                    3.500000013119745e-12, 3.499999999567217e-12, 3.499999999567217e-12, 3.499999999567217e-12,
                    3.499999999567217e-12
                ],
                [
                    -4.046503619999999e-05, -4.046503620003250e-05, -4.046503620003250e-05, -4.046503620003250e-05,
                    -4.046503619997699e-05, -4.046503620000474e-05, -4.046503620000474e-05, -4.046503619999781e-05,
                    -4.046503619999781e-05, -2.040760475891100e-05, -2.070508084582848e-05, -2.130791199295769e-05,
                    -2.252245599872364e-05, -2.500970482427259e-05, -3.019421004650013e-05, -4.142587254284315e-05,
                    -6.731706965778303e-05, -1.328327234189963e-04, -3.187666653282306e-04, -5.938485742955228e-04,
                    -6.169146155000001e-04, -6.169146155000001e-04, -6.169146155000000e-04, -6.169146155000001e-04,
                    -6.169146154999999e-04, -6.169146155000000e-04, -6.169146155000000e-04, -6.169146155000000e-04,
                    -6.169146155000000e-04, -5.514505305937558e-04, -3.942014886276665e-04, -1.628129816090945e-04,
                    -6.050920039415270e-05, -4.046503620000128e-05, -4.046503620000128e-05, -4.046503619999954e-05,
                    -4.046503620000041e-05, -4.046503619999997e-05, -4.046503619999997e-05, -4.046503619999997e-05,
                    -4.046503620000000e-05, -4.046503619999999e-05, -4.046503619999999e-05, -4.046503619999999e-05,
                    -4.046503619999999e-05, -2.567493730834173e-05, -3.743225113296127e-05, -6.522226283994193e-05,
                    -1.371071045481330e-04, -3.468814091758478e-04, -5.938117070697452e-04, -6.169146154999994e-04,
                    -6.169146155000009e-04, -6.169146154999993e-04, -6.169146155000008e-04, -6.169146154999991e-04,
                    -6.169146155000009e-04, -6.169146154999994e-04, -6.169146155000009e-04, -6.169146154999994e-04,
                    -6.169146155000009e-04, -6.136898557124026e-04, -5.625978207465280e-04, -4.675803140918641e-04,
                    -3.046917599841760e-04, -8.898448829112524e-05, -6.064762143616348e-05, -4.046503620002903e-05,
                    -4.046503619996658e-05, -4.046503620003250e-05, -4.046503619996832e-05, -4.046503620003163e-05,
                    -4.046503619996875e-05, -4.046503620003120e-05, -4.046503619996875e-05, -4.046503620003123e-05,
                    -4.046503619996877e-05, -4.046503620003122e-05, -4.046503619996877e-05, -4.046503620003122e-05,
                    -2.530060400042196e-05, -3.618289111043231e-05, -6.167814631092216e-05, -1.268484357367632e-04,
                    -3.146419874001269e-04, -5.938234052156549e-04, -6.169146154999994e-04, -6.169146155000009e-04,
                    -6.169146154999994e-04, -6.169146155000009e-04, -6.169146154999991e-04, -6.169146155000009e-04,
                    -6.169146154999994e-04, -6.169146155000009e-04, -6.169146154999991e-04, -5.514505305937584e-04,
                    -3.942014886276712e-04, -1.628129816090986e-04, -6.050920039415458e-05, -4.046503620001862e-05,
                    -4.046503619998393e-05, -4.046503620001689e-05, -4.046503619998306e-05, -4.046503620001732e-05,
                    -4.046503619998263e-05, -4.046503620001732e-05, -4.046503619998265e-05, -4.046503620001734e-05,
                    -4.046503619998265e-05, -4.046503620001734e-05, -4.046503619998265e-05, -2.567493730834567e-05,
                    -3.743225113294762e-05, -6.522226283993644e-05, -1.371071045480873e-04, -3.468814091757431e-04,
                    -5.938117070697358e-04, -6.169146154999994e-04, -6.169146155000009e-04, -6.169146154999993e-04,
                    -6.169146155000009e-04, -6.169146154999993e-04, -6.169146155000009e-04, -6.169146154999994e-04,
                    -6.169146155000009e-04, -6.169146154999994e-04, -6.169146155000009e-04, -6.136898557126451e-04,
                    -5.625978207472211e-04, -4.675803140933423e-04, -3.046917599867062e-04, -8.898448829370689e-05,
                    -6.064762143616391e-05, -4.046503620002903e-05, -4.046503619996658e-05, -4.046503620003250e-05,
                    -4.046503619996832e-05, -4.046503620003163e-05, -4.046503619996875e-05, -4.046503620003120e-05,
                    -4.046503619996875e-05, -4.046503620003123e-05, -4.046503619996877e-05, -4.046503620003122e-05,
                    -4.046503619996877e-05, -4.046503620003122e-05, -2.530060399998473e-05, -3.618289110895970e-05,
                    -6.167814630679439e-05, -1.268484357248565e-04, -3.146419873629925e-04, -5.938234052156595e-04,
                    -6.169146155000001e-04, -6.169146155000001e-04, -6.169146155000000e-04, -6.169146155000001e-04,
                    -6.169146155000000e-04, -6.169146155000000e-04, -6.169146155000000e-04, -6.169146155000000e-04,
                    -6.169146154999888e-04, -5.514505305937448e-04, -3.942014886276581e-04, -1.628129816090919e-04,
                    -6.050920039414972e-05, -4.046503620000128e-05, -4.046503620000128e-05, -4.046503619999954e-05,
                    -4.046503620000041e-05, -4.046503619999997e-05, -4.046503619999997e-05, -4.046503619999997e-05,
                    -4.046503620000000e-05, -4.046503619999999e-05, -4.046503619999999e-05, -4.046503619999999e-05,
                    -4.046503619999999e-05
                ]
            ];

            // Analyze
            AnalyzeTransient(tran, ckt, exports, references);
            DestroyExports(exports);
        }

        [Test]
        public void When_ParallelMultiplier_Expect_Reference()
        {
            // Build the circuit
            var ckt_ref = new Circuit(
                new VoltageSource("V1", "g", "0", 0.5)
                    .SetParameter("acmag", 1.0),
                new VoltageSource("V2", "d", "0", 2.0),
                CreateJFET("J1", "d", "g", "0", "JX"),
                CreateJFET("J2", "d", "g", "0", "JX"),
                CreateJFETModel("JX", "IS=1.500E-12 BETA=696.7E-6 VTO=-0.241 CGS=1e-12 CGD=5e-12")
            );
            var ckt_act = new Circuit(
                new VoltageSource("V1", "g", "0", 0.5)
                    .SetParameter("acmag", 1.0),
                new VoltageSource("V2", "d", "0", 2.0),
                CreateJFET("J1", "d", "g", "0", "JX")
                    .SetParameter("m", 2.0),
                CreateJFETModel("JX", "IS=1.500E-12 BETA=696.7E-6 VTO=-0.241 CGS=1e-12 CGD=5e-12")
            );

            var op = new OP("op");
            op.BiasingParameters.Gmin = 0.0; // May interfere with comparison
            var exports = new[] { new RealCurrentExport(op, "V1"), new RealCurrentExport(op, "V2") };
            Compare(op, ckt_ref, ckt_act, exports);
            DestroyExports(exports);
        }

        [Test]
        public void When_ParallelMultiplierAC_Expect_Reference()
        {
            // Build the circuit
            var ckt_ref = new Circuit(
                new VoltageSource("V1", "g", "0", 0.5)
                    .SetParameter("acmag", 1.0),
                new VoltageSource("V2", "d", "0", 2.0),
                CreateJFET("J1", "d", "g", "0", "JX"),
                CreateJFET("J2", "d", "g", "0", "JX"),
                CreateJFETModel("JX", "IS=1.500E-12 BETA=696.7E-6 VTO=-0.241 CGS=1e-12 CGD=5e-12")
            );
            var ckt_act = new Circuit(
                new VoltageSource("V1", "g", "0", 0.5)
                    .SetParameter("acmag", 1.0),
                new VoltageSource("V2", "d", "0", 2.0),
                CreateJFET("J1", "d", "g", "0", "JX")
                    .SetParameter("m", 2.0),
                CreateJFETModel("JX", "IS=1.500E-12 BETA=696.7E-6 VTO=-0.241 CGS=1e-12 CGD=5e-12")
            );

            // Create the simulation
            var ac = new AC("ac", new DecadeSweep(0.1, 10e9, 10));
            ac.BiasingParameters.Gmin = 0.0; // May interfere with comparison
            var exports = new[] { new ComplexCurrentExport(ac, "V1"), new ComplexCurrentExport(ac, "V2") };
            Compare(ac, ckt_ref, ckt_act, exports);
            DestroyExports(exports);
        }
    }
}
