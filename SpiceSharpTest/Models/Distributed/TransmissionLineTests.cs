using NUnit.Framework;
using SpiceSharp;
using SpiceSharp.Components;
using SpiceSharp.Simulations;
using System;
using System.Numerics;

namespace SpiceSharpTest.Models
{
    [TestFixture]
    public class TransmissionLineTests : Framework
    {
        [Test]
        public void When_TerminatedTransient_Expect_Reference()
        {
            // Build the circuit
            var ckt = new Circuit(
                new VoltageSource("V1", "in", "0", new Pulse(1, 5, 2e-6, 1e-9, 1e-9, 5e-6, 10e-6)),
                new Resistor("Rsource", "in", "a", 100),
                new LosslessTransmissionLine("T1", "a", "0", "b", "0", 50.0, 1e-6)
                    .SetParameter("reltol", 0.5),
                new Resistor("Rload", "b", "0", 25)
            );

            // Build the simulation
            var tran = new Transient("tran", 1e-6, 20e-6);
            var exports = new IExport<double>[]
            {
                new GenericExport<double>(tran, () => tran.GetState<IIntegrationMethod>().Time),
                new RealVoltageExport(tran, "a"),
                new RealVoltageExport(tran, "b")
            };

            // Reference inspected 2018-12-05
            var references = new[]
            {
                new[]
                {
                    0, 4E-09, 8E-09, 1.6E-08, 3.2E-08, 6.4E-08, 1.28E-07, 2.56E-07, 5.12E-07, 9.12E-07, 1.312E-06,
                    1.712E-06, 2E-06, 2.0001E-06, 2.0003E-06, 2.0007E-06, 2.001E-06, 2.00108E-06, 2.00124E-06,
                    2.00156E-06, 2.0022E-06, 2.00348E-06, 2.00604E-06, 2.01116E-06, 2.0214E-06, 2.04188E-06,
                    2.08284000000001E-06, 2.16476000000001E-06, 2.32860000000002E-06, 2.65628000000005E-06, 3E-06,
                    3.0001E-06, 3.0003E-06, 3.0007E-06, 3.001E-06, 3.00108E-06, 3.00124E-06, 3.00156E-06, 3.0022E-06,
                    3.00348E-06, 3.00604E-06, 3.01116E-06, 3.02139999999999E-06, 3.04187999999999E-06,
                    3.08283999999997E-06, 3.16475999999994E-06, 3.32859999999989E-06, 3.65627999999977E-06, 4E-06,
                    4.0001E-06, 4.0003E-06, 4.0007E-06, 4.001E-06, 4.00108E-06, 4.00124E-06, 4.00156E-06, 4.0022E-06,
                    4.00348E-06, 4.00604E-06, 4.01116E-06, 4.02139999999999E-06, 4.04187999999999E-06,
                    4.08283999999997E-06, 4.16475999999994E-06, 4.32859999999989E-06, 4.65627999999977E-06, 5E-06,
                    5.0001E-06, 5.0003E-06, 5.0007E-06, 5.001E-06, 5.00108E-06, 5.00124E-06, 5.00156E-06, 5.0022E-06,
                    5.00348E-06, 5.00604E-06, 5.01116E-06, 5.02139999999999E-06, 5.04187999999999E-06,
                    5.08283999999997E-06, 5.16475999999994E-06, 5.32859999999988E-06, 5.65627999999977E-06, 6E-06,
                    6.0001E-06, 6.0003E-06, 6.0007E-06, 6.001E-06, 6.00108E-06, 6.00124E-06, 6.00156E-06, 6.0022E-06,
                    6.00348E-06, 6.00604E-06, 6.01116E-06, 6.02139999999999E-06, 6.04187999999998E-06,
                    6.08283999999997E-06, 6.16475999999994E-06, 6.32859999999988E-06, 6.65627999999977E-06, 7E-06,
                    7.0001E-06, 7.0003E-06, 7.0007E-06, 7.001E-06, 7.0010000008E-06, 7.0010000024E-06, 7.0010000056E-06,
                    7.001000012E-06, 7.0010000248E-06, 7.0010000504E-06, 7.0010001016E-06, 7.001000204E-06,
                    7.0010004088E-06, 7.0010008184E-06, 7.0010016376E-06, 7.001003276E-06, 7.0010065528E-06,
                    7.0010131064E-06, 7.0010262136E-06, 7.001052428E-06, 7.0011048568E-06, 7.0012097144E-06,
                    7.0014194296E-06, 7.00183886E-06, 7.002E-06, 7.00208388608E-06, 7.00225165824E-06,
                    7.00258720256E-06, 7.0032582912E-06, 7.00460046848E-06, 7.00728482304E-06, 7.01265353216E-06,
                    7.0233909504E-06, 7.04486578688E-06, 7.08781545984E-06, 7.17371480576E-06, 7.3455134976E-06,
                    7.68911088128E-06, 8E-06, 8.0001E-06, 8.0003E-06, 8.0007E-06, 8.001E-06, 8.00108E-06, 8.00124E-06,
                    8.00156E-06, 8.002E-06, 8.002064E-06, 8.002192E-06, 8.002448E-06, 8.00296E-06, 8.003984E-06,
                    8.006032E-06, 8.01012799999999E-06, 8.01831999999998E-06, 8.03470399999996E-06,
                    8.06747199999992E-06, 8.13300799999984E-06, 8.26407999999969E-06, 8.52622399999938E-06,
                    8.92622399999937E-06, 9E-06, 9.0001E-06, 9.0003E-06, 9.0007E-06, 9.001E-06, 9.00108E-06,
                    9.00124E-06, 9.00156E-06, 9.002E-06, 9.002064E-06, 9.002192E-06, 9.002448E-06, 9.00296E-06,
                    9.003984E-06, 9.006032E-06, 9.01012799999999E-06, 9.01831999999998E-06, 9.03470399999996E-06,
                    9.06747199999992E-06, 9.13300799999984E-06, 9.26407999999969E-06, 9.52622399999938E-06,
                    9.92622399999938E-06, 1E-05, 1.00001E-05, 1.00003E-05, 1.00007E-05, 1.0001E-05, 1.000108E-05,
                    1.000124E-05, 1.000156E-05, 1.0002E-05, 1.0002064E-05, 1.0002192E-05, 1.0002448E-05, 1.000296E-05,
                    1.0003984E-05, 1.0006032E-05, 1.0010128E-05, 1.001832E-05, 1.0034704E-05, 1.00674719999999E-05,
                    1.01330079999998E-05, 1.02640799999997E-05, 1.05262239999994E-05, 1.09262239999994E-05, 1.1E-05,
                    1.10001E-05, 1.10003E-05, 1.10007E-05, 1.1001E-05, 1.100108E-05, 1.100124E-05, 1.100156E-05,
                    1.1002E-05, 1.1002064E-05, 1.1002192E-05, 1.1002448E-05, 1.100296E-05, 1.1003984E-05, 1.1006032E-05,
                    1.1010128E-05, 1.101832E-05, 1.1034704E-05, 1.10674719999999E-05, 1.11330079999998E-05,
                    1.12640799999997E-05, 1.15262239999994E-05, 1.19262239999994E-05, 1.2E-05, 1.20000000008E-05,
                    1.20000000024E-05, 1.20000000056E-05, 1.2000000012E-05, 1.20000000248E-05, 1.20000000504E-05,
                    1.20000001016E-05, 1.2000000204E-05, 1.20000004088E-05, 1.20000008184E-05, 1.20000016376E-05,
                    1.2000003276E-05, 1.20000065528E-05, 1.20000131064E-05, 1.20000262136E-05, 1.2000052428E-05,
                    1.20001048568E-05, 1.20002097144E-05, 1.20004194296E-05, 1.200083886E-05, 1.2001E-05,
                    1.200108388608E-05, 1.200125165824E-05, 1.200158720256E-05, 1.2002E-05, 1.2002067108864E-05,
                    1.2002201326592E-05, 1.2002469762048E-05, 1.200300663296E-05, 1.2004080374784E-05,
                    1.2006227858432E-05, 1.2010522825728E-05, 1.201911276032E-05, 1.2036292629504E-05,
                    1.2070652367872E-05, 1.2139371844608E-05, 1.227681079808E-05, 1.2551688705024E-05,
                    1.2951688705024E-05, 1.3E-05, 1.30001E-05, 1.30003E-05, 1.30007E-05, 1.3001E-05, 1.300108E-05,
                    1.300124E-05, 1.300156E-05, 1.3002E-05, 1.3002064E-05, 1.3002192E-05, 1.3002448E-05, 1.300296E-05,
                    1.3003984E-05, 1.3006032E-05, 1.3010128E-05, 1.301832E-05, 1.3034704E-05, 1.3067472E-05,
                    1.31330080000001E-05, 1.32640800000001E-05, 1.35262240000003E-05, 1.39262240000003E-05, 1.4E-05,
                    1.40001E-05, 1.40003E-05, 1.40007E-05, 1.4001E-05, 1.400108E-05, 1.400124E-05, 1.400156E-05,
                    1.4002E-05, 1.4002064E-05, 1.4002192E-05, 1.4002448E-05, 1.400296E-05, 1.4003984E-05, 1.4006032E-05,
                    1.4010128E-05, 1.401832E-05, 1.4034704E-05, 1.4067472E-05, 1.41330080000001E-05,
                    1.42640800000001E-05, 1.45262240000003E-05, 1.49262240000003E-05, 1.5E-05, 1.50001E-05, 1.50003E-05,
                    1.50007E-05, 1.5001E-05, 1.500108E-05, 1.500124E-05, 1.500156E-05, 1.5002E-05, 1.5002064E-05,
                    1.5002192E-05, 1.5002448E-05, 1.500296E-05, 1.5003984E-05, 1.5006032E-05, 1.5010128E-05,
                    1.501832E-05, 1.5034704E-05, 1.5067472E-05, 1.51330080000001E-05, 1.52640800000001E-05,
                    1.55262240000003E-05, 1.59262240000003E-05, 1.6E-05, 1.60001E-05, 1.60003E-05, 1.60007E-05,
                    1.6001E-05, 1.600108E-05, 1.600124E-05, 1.600156E-05, 1.6002E-05, 1.6002064E-05, 1.6002192E-05,
                    1.6002448E-05, 1.600296E-05, 1.6003984E-05, 1.6006032E-05, 1.6010128E-05, 1.601832E-05,
                    1.6034704E-05, 1.60674719999999E-05, 1.61330079999998E-05, 1.62640799999997E-05,
                    1.65262239999994E-05, 1.69262239999994E-05, 1.7E-05, 1.70001E-05, 1.70003E-05, 1.70007E-05,
                    1.7001E-05, 1.700108E-05, 1.700124E-05, 1.700156E-05, 1.7002E-05, 1.70020000008E-05,
                    1.70020000024E-05, 1.70020000056E-05, 1.7002000012E-05, 1.70020000248E-05, 1.70020000504E-05,
                    1.70020001016E-05, 1.7002000204E-05, 1.70020004088E-05, 1.70020008184E-05, 1.70020016376E-05,
                    1.7002003276E-05, 1.70020065528E-05, 1.70020131064E-05, 1.70020262136E-05, 1.7002052428E-05,
                    1.70021048568E-05, 1.70022097144E-05, 1.70024194296E-05, 1.700283886E-05, 1.70036777208E-05,
                    1.70053554424E-05, 1.70087108856E-05, 1.7015421772E-05, 1.70288435448E-05, 1.70556870904E-05,
                    1.71093741816E-05, 1.7216748364E-05, 1.74314967288E-05, 1.78314967288E-05, 1.8E-05, 1.80001E-05,
                    1.80003E-05, 1.80007E-05, 1.8001E-05, 1.800108E-05, 1.800124E-05, 1.800156E-05, 1.8002E-05,
                    1.8002064E-05, 1.8002192E-05, 1.8002448E-05, 1.800296E-05, 1.8003984E-05, 1.8006032E-05,
                    1.8010128E-05, 1.801832E-05, 1.8034704E-05, 1.80674719999999E-05, 1.81330079999998E-05,
                    1.82640799999997E-05, 1.85262239999994E-05, 1.89262239999994E-05, 1.9E-05, 1.90001E-05, 1.90003E-05,
                    1.90007E-05, 1.9001E-05, 1.900108E-05, 1.900124E-05, 1.900156E-05, 1.9002E-05, 1.9002064E-05,
                    1.9002192E-05, 1.9002448E-05, 1.900296E-05, 1.9003984E-05, 1.9006032E-05, 1.9010128E-05,
                    1.901832E-05, 1.9034704E-05, 1.90674719999999E-05, 1.91330079999998E-05, 1.92640799999997E-05,
                    1.95262239999994E-05, 1.99262239999994E-05, 2E-05
                },
                new[]
                {
                    0.2, 0.2, 0.2, 0.2, 0.2, 0.2, 0.2, 0.2, 0.2, 0.2, 0.2, 0.2, 0.2, 0.333333333333061,
                    0.599999999999747, 1.13333333333312, 1.53333333333333, 1.53333333333333, 1.53333333333333,
                    1.53333333333333, 1.53333333333333, 1.53333333333333, 1.53333333333333, 1.53333333333333,
                    1.53333333333333, 1.53333333333333, 1.53333333333333, 1.53333333333333, 1.53333333333333,
                    1.53333333333333, 1.53333333333333, 1.53333333333333, 1.53333333333333, 1.53333333333333,
                    1.53333333333333, 1.53333333333333, 1.53333333333333, 1.53333333333333, 1.53333333333333,
                    1.53333333333333, 1.53333333333333, 1.53333333333333, 1.53333333333333, 1.53333333333333,
                    1.53333333333333, 1.53333333333333, 1.53333333333333, 1.53333333333333, 1.53333333333308,
                    1.47407407407394, 1.35555555555542, 1.11851851851836, 0.940740740740741, 0.940740740740741,
                    0.940740740740741, 0.940740740740741, 0.940740740740741, 0.94074074074074, 0.940740740740741,
                    0.940740740740741, 0.940740740740741, 0.940740740740741, 0.940740740740741, 0.940740740740741,
                    0.940740740740741, 0.940740740740741, 0.940740740740741, 0.94074074074074, 0.940740740740741,
                    0.940740740740741, 0.940740740740741, 0.940740740740741, 0.940740740740741, 0.940740740740741,
                    0.94074074074074, 0.940740740740741, 0.940740740740741, 0.940740740740741, 0.940740740740741,
                    0.940740740740741, 0.940740740740741, 0.940740740740741, 0.940740740740741, 0.940740740740741,
                    0.940740740740768, 0.947325102880672, 0.960493827160509, 0.986831275720182, 1.00658436213992,
                    1.00658436213992, 1.00658436213992, 1.00658436213992, 1.00658436213992, 1.00658436213992,
                    1.00658436213992, 1.00658436213992, 1.00658436213992, 1.00658436213992, 1.00658436213992,
                    1.00658436213992, 1.00658436213992, 1.00658436213992, 1.00658436213992, 1.00658436213992,
                    1.00658436213992, 1.00658436213992, 1.00658436213992, 1.00658329547472, 1.00658116214205,
                    1.00657689547447, 1.00656836214155, 1.00655129547573, 1.00651716214182, 1.00644889547626,
                    1.00631236214288, 1.00603929547613, 1.00549316214262, 1.00440089547561, 1.00221636214158,
                    0.997847295475777, 0.989109162141918, 0.971632895474197, 0.936680362141015, 0.866775295474653,
                    0.726965162141927, 0.447344895474217, -0.111895637858944, -0.326748971193416, -0.326748971193416,
                    -0.326748971193416, -0.326748971193416, -0.326748971193416, -0.326748971193416, -0.326748971193416,
                    -0.326748971193416, -0.326748971193416, -0.326748971193416, -0.326748971193416, -0.326748971193416,
                    -0.326748971193416, -0.326748971193416, -0.326748971193425, -0.327480566986748, -0.328943758573402,
                    -0.331870141746693, -0.334064929126658, -0.334064929126658, -0.334064929126658, -0.334064929126658,
                    -0.334064929126658, -0.334064929126658, -0.334064929126658, -0.334064929126658, -0.334064929126658,
                    -0.334064929126658, -0.334064929126658, -0.334064929126658, -0.334064929126658, -0.334064929126658,
                    -0.334064929126658, -0.334064929126658, -0.334064929126658, -0.334064929126658, -0.334064929126658,
                    -0.334064929126658, -0.334064929126658, -0.334064929126658, -0.334064929126658, -0.334064929126658,
                    -0.286657521719447, -0.19184270690558, -0.00221307727503345, 0.258527663465935, 0.258527663465935,
                    0.258527663465935, 0.258527663465935, 0.258527663465935, 0.258527663465935, 0.258527663465935,
                    0.258527663465935, 0.258527663465935, 0.258527663465935, 0.258527663465935, 0.258527663465935,
                    0.258527663465935, 0.258527663465935, 0.258527663465936, 0.258527663465936, 0.258608951887417,
                    0.258771528730378, 0.259096682416299, 0.25934054768074, 0.25934054768074, 0.25934054768074,
                    0.25934054768074, 0.25934054768074, 0.25934054768074, 0.25934054768074, 0.25934054768074,
                    0.25934054768074, 0.25934054768074, 0.25934054768074, 0.25934054768074, 0.25934054768074,
                    0.25934054768074, 0.25934054768074, 0.25934054768074, 0.25934054768074, 0.25934054768074,
                    0.25934054768074, 0.25934054768074, 0.25934054768074, 0.25934054768074, 0.25934054768074,
                    0.25934054768074, 0.254073057968828, 0.243538078545065, 0.222468119697226, 0.193496926281563,
                    0.193496926281563, 0.193496926281563, 0.193496926281563, 0.193496926281563, 0.193496926281563,
                    0.193496926281563, 0.193496926281563, 0.193496926281563, 0.193496926281563, 0.193496926281563,
                    0.193496926281563, 0.193496926281563, 0.193496926281563, 0.193496926281563, 0.193496926281563,
                    0.193497992876768, 0.193500126065211, 0.193504392444163, 0.193512925199807, 0.193529990711094,
                    0.193564121735927, 0.193632383783328, 0.19376890788037, 0.194041956074377, 0.194588052462084,
                    0.195680245236266, 0.197864630779708, 0.202233401844642, 0.210970943898004, 0.228446027689667,
                    0.263396190961211, 0.333296522233804, 0.473097184778992, 0.752698509871626, 1.31190116005464,
                    1.52673993914658, 1.52673993914658, 1.52673993914658, 1.52673993914658, 1.52673993914658,
                    1.52673993914658, 1.52673993914658, 1.52673993914658, 1.52673993914658, 1.52673993914658,
                    1.52673993914658, 1.52673993914658, 1.52673993914658, 1.52673993914658, 1.52673993914658,
                    1.52673993914658, 1.52673993914658, 1.52673993914658, 1.52673993914658, 1.52673993914658,
                    1.52673993914658, 1.52673993914658, 1.52673993914658, 1.52673993914658, 1.52732521578124,
                    1.52849576905055, 1.5308368755892, 1.53405589707983, 1.53405589707983, 1.53405589707983,
                    1.53405589707983, 1.53405589707983, 1.53405589707983, 1.53405589707983, 1.53405589707983,
                    1.53405589707983, 1.53405589707983, 1.53405589707983, 1.53405589707983, 1.53405589707983,
                    1.53405589707983, 1.53405589707983, 1.53405589707983, 1.4747976413812, 1.35628112998394,
                    1.11924810718941, 0.941473340094824, 0.941473340094824, 0.941473340094824, 0.941473340094824,
                    0.941473340094824, 0.941473340094824, 0.941473340094824, 0.941473340094824, 0.941473340094824,
                    0.941473340094824, 0.941473340094824, 0.941473340094824, 0.941473340094824, 0.941473340094824,
                    0.941473340094824, 0.941473340094824, 0.941473340094824, 0.941473340094824, 0.941473340094824,
                    0.941473340094824, 0.941473340094824, 0.941473340094824, 0.941473340094824, 0.941473340094824,
                    0.941408309357639, 0.941278247883273, 0.941018124934534, 0.94066045588002, 0.94066045588002,
                    0.94066045588002, 0.94066045588002, 0.94066045588002, 0.94066045588002, 0.94066045588002,
                    0.94066045588002, 0.94066045588002, 0.94066045588002, 0.94066045588002, 0.94066045588002,
                    0.94066045588002, 0.94066045588002, 0.94066045588002, 0.94066045588002, 0.9472447065132,
                    0.960413207779563, 0.986750210312288, 1.00650296221157, 1.00650296221169, 1.00650296221169,
                    1.00650296221169, 1.00650296221169, 1.00650296221169, 1.00650296221169, 1.00650296221169,
                    1.00650296221169, 1.00650296221169, 1.00650296221169, 1.00650296221169, 1.00650296221169,
                    1.00650296221169, 1.00650296221169, 1.00650296221169, 1.00650296221169, 1.00650296221169,
                    1.00650296221169, 1.00650296221169, 1.00650296221169, 1.00650296221169, 1.00650296221169,
                    1.00650296220943, 0.899843521181798, 0.686524639122024, 0.259886875006992, -0.326740050653336,
                    -0.326740050653336, -0.32674005062581, -0.326740050589114, -0.32674005051573, -0.326740050369008,
                    -0.32674005007574, -0.326740049489908, -0.326740048321064, -0.326740045994649, -0.326740041386918,
                    -0.326740032351852, -0.326740015003305, -0.326739983192546, -0.326739931116368, -0.326739873145377,
                    -0.326740050653336, -0.326740050653336, -0.326740050653336, -0.326740050653336, -0.326740050653336,
                    -0.326740050653336, -0.326740050653336, -0.326740050653336, -0.326740050653336, -0.326740050653336,
                    -0.326740050653336, -0.326740050653336, -0.326740050653336, -0.326740050653336, -0.326740050653336,
                    -0.326740050653336, -0.327471634057022, -0.328934800864396, -0.331861134479143, -0.334055884690175,
                    -0.334055884690188, -0.334055884690188, -0.334055884690188, -0.334055884690188, -0.334055884690188,
                    -0.334055884690187, -0.334055884690188, -0.334055884690188, -0.334055884690188, -0.334055884690187,
                    -0.334055884690188, -0.334055884690188, -0.334055884690188, -0.334055884690188, -0.334055884690187,
                    -0.334055884690188, -0.334055884690187, -0.334055884690188, -0.334055884690188, -0.334055884690188,
                    -0.334055884690188, -0.334055884690188, -0.334055884689184, -0.286649280131082, -0.191836071012873,
                    -0.00220965277846058, 0.258526672294815, 0.258526672294815, 0.258526672294815, 0.258526672294815,
                    0.258526672294815, 0.258526672294815, 0.258526672294815, 0.258526672294815, 0.258526672294815,
                    0.258526672294815, 0.258526672294815, 0.258526672294815, 0.258526672294815, 0.258526672294815,
                    0.258526672294815, 0.258526672294815
                },
                new[]
                {
                    0.2, 0.2, 0.2, 0.2, 0.2, 0.2, 0.2, 0.2, 0.2, 0.2, 0.2, 0.2, 0.2, 0.2, 0.2, 0.2, 0.2, 0.2, 0.2, 0.2,
                    0.2, 0.2, 0.2, 0.2, 0.2, 0.2, 0.2, 0.2, 0.2, 0.2, 0.200000000000376, 0.288888888888707,
                    0.466666666666875, 0.822222222222457, 1.08888888888889, 1.08888888888889, 1.08888888888889,
                    1.08888888888889, 1.08888888888889, 1.08888888888889, 1.08888888888889, 1.08888888888889,
                    1.08888888888889, 1.08888888888889, 1.08888888888889, 1.08888888888889, 1.08888888888889,
                    1.08888888888889, 1.08888888888889, 1.08888888888889, 1.08888888888889, 1.08888888888889,
                    1.08888888888889, 1.08888888888889, 1.08888888888889, 1.08888888888889, 1.08888888888889,
                    1.08888888888889, 1.08888888888889, 1.08888888888889, 1.08888888888889, 1.08888888888889,
                    1.08888888888889, 1.08888888888889, 1.08888888888889, 1.08888888888889, 1.08888888888885,
                    1.07901234567899, 1.05925925925924, 1.01975308641973, 0.990123456790124, 0.990123456790124,
                    0.990123456790124, 0.990123456790124, 0.990123456790124, 0.990123456790123, 0.990123456790124,
                    0.990123456790124, 0.990123456790124, 0.990123456790124, 0.990123456790124, 0.990123456790124,
                    0.990123456790124, 0.990123456790124, 0.990123456790124, 0.990123456790123, 0.990123456790124,
                    0.990123456790124, 0.990123456790124, 0.990123456790124, 0.990123456790124, 0.990123456790124,
                    0.990123456790123, 0.990123456790124, 0.990123456790124, 0.990123456790124, 0.990123456790124,
                    0.990123456790124, 0.990123456790124, 0.990123456790124, 0.990123456790124, 0.990123456790124,
                    0.990123456790128, 0.991220850480112, 0.993415637860085, 0.997805212620031, 1.00109739368999,
                    1.00109739368999, 1.00109739923455, 1.00109740662677, 1.00109742140946, 1.00109745096773,
                    1.00109751005587, 1.00109762811862, 1.00109786378988, 1.0010983333155, 1.00109926509917,
                    1.00110109959617, 1.00110465230883, 1.00111129260883, 1.0011227127075, 1.00113811089958,
                    1.00109739368999, 1.00109739368999, 1.00109739368999, 1.00109739368999, 1.00109739368999,
                    1.00109739368999, 1.00109739368999, 1.00109739368999, 1.00109739368999, 1.00109739368999,
                    1.00109739368999, 1.00109739368999, 1.00109739368999, 1.00109739368999, 1.00109739368999,
                    1.00109739368999, 1.00109739368999, 1.00109739368999, 1.00109739368999, 1.00109739368999,
                    1.00109739368999, 1.00109739368999, 1.00109739368999, 1.00109739368999, 0.929986282579171,
                    0.787764060358371, 0.50331961591255, 0.112208504801097, 0.112208504801097, 0.112208504801097,
                    0.112208504801097, 0.112208504801097, 0.112208504801097, 0.112208504801097, 0.112208504801097,
                    0.112208504801097, 0.112208504801097, 0.112208504801097, 0.112208504801097, 0.112208504801097,
                    0.112208504801097, 0.112208504801096, 0.112208504801096, 0.112086572168875, 0.111842706904433,
                    0.111354976375551, 0.11098917847889, 0.11098917847889, 0.11098917847889, 0.11098917847889,
                    0.11098917847889, 0.11098917847889, 0.11098917847889, 0.11098917847889, 0.11098917847889,
                    0.11098917847889, 0.11098917847889, 0.11098917847889, 0.11098917847889, 0.11098917847889,
                    0.11098917847889, 0.11098917847889, 0.11098917847889, 0.11098917847889, 0.11098917847889,
                    0.11098917847889, 0.11098917847889, 0.11098917847889, 0.11098917847889, 0.11098917847889,
                    0.118890413046759, 0.134692882182403, 0.166297820454161, 0.209754610577656, 0.209754610577656,
                    0.209754610577656, 0.209754610577656, 0.209754610577656, 0.209754610577656, 0.209754610577656,
                    0.209754610577656, 0.209754610577656, 0.209754610577656, 0.209754610577656, 0.209754610577656,
                    0.209754610577656, 0.209754610577656, 0.209754610577656, 0.209754610577656, 0.209768158647903,
                    0.209795254788396, 0.209849447069383, 0.209890091280123, 0.209890091280123, 0.209890091280123,
                    0.209890091280123, 0.209890091280123, 0.209890091280123, 0.209890091280123, 0.209890091280123,
                    0.209890091280123, 0.209890091280123, 0.209890091280123, 0.209890091280123, 0.209890091280123,
                    0.209890091280123, 0.209890091280123, 0.209890091280123, 0.209890091280123, 0.209890091280123,
                    0.209890091280123, 0.209890091280123, 0.209890091280123, 0.209890091280123, 0.209890091280123,
                    0.209890091280123, 0.209890091280123, 0.209890091280123, 0.209890091280123, 0.209890091280123,
                    0.209890091280123, 0.209890091280123, 0.209890091280123, 0.209890091280123, 0.209890091280123,
                    0.209890091280123, 0.209890091280123, 0.209890091280123, 0.209890091280123, 0.209890091280123,
                    0.209890091280123, 0.209890091280123, 0.209890091280123, 0.208969530731444, 0.207128409634057,
                    0.20344616743925, 0.198916154380261, 0.198916154380261, 0.198916154380261, 0.198916154380261,
                    0.198916154380261, 0.198916154380261, 0.198916154380261, 0.198916154380261, 0.198916154380261,
                    0.198916154380261, 0.198916154380261, 0.198916154380261, 0.198916154380261, 0.198916154380261,
                    0.198916154380261, 0.198916154380261, 0.287803537928206, 0.465578305024096, 0.821127839215878,
                    1.08778998985776, 1.08778998985776, 1.08778998985776, 1.08778998985776, 1.08778998985776,
                    1.08778998985776, 1.08778998985776, 1.08778998985776, 1.08778998985776, 1.08778998985776,
                    1.08778998985776, 1.08778998985776, 1.08778998985776, 1.08778998985776, 1.08778998985776,
                    1.08778998985776, 1.08778998985776, 1.08778998985776, 1.08778998985776, 1.08778998985776,
                    1.08778998985776, 1.08778998985776, 1.08778998985776, 1.08778998985776, 1.08788753596354,
                    1.08808262817509, 1.0884728125982, 1.08900931617997, 1.08900931617997, 1.08900931617997,
                    1.08900931617997, 1.08900931617997, 1.08900931617997, 1.08900931617997, 1.08900931617997,
                    1.08900931617997, 1.08900931617997, 1.08900931617997, 1.08900931617997, 1.08900931617997,
                    1.08900931617997, 1.08900931617997, 1.08900931617997, 1.0791329402302, 1.05938018833066,
                    1.01987468453157, 0.990245556682471, 0.990245556682471, 0.990245556682471, 0.990245556682471,
                    0.990245556682471, 0.990245556682471, 0.990245556682471, 0.990245556682471, 0.990245556682471,
                    0.990245556682471, 0.990245556682471, 0.990245556682471, 0.990245556682471, 0.990245556682471,
                    0.990245556682471, 0.990245556682471, 0.990245556682471, 0.990245556682471, 0.990245556682471,
                    0.990245556682471, 0.990245556682471, 0.990245556682471, 0.990245556682471, 0.990245556682471,
                    0.990234718226274, 0.990213041313879, 0.99016968748909, 0.990110075980004, 0.990110075980003,
                    0.990110075980003, 0.990110075980003, 0.990110075980003, 0.990110075980003, 0.990110075980003,
                    0.990110075980003, 0.990110075980003, 0.990110075980003, 0.990110075980003, 0.990110075980003,
                    0.990110075980003, 0.990110075980003, 0.990110075980003, 0.990110075980003, 0.991207451085534,
                    0.993402201296594, 0.997791701718715, 1.00108382703526, 1.00108382703528, 1.00108382703528,
                    1.00108382703528, 1.00108382703528, 1.00108382703528, 1.00108382703528, 1.00108382703528,
                    1.00108382703528, 1.00108382703528, 1.00108382703528, 1.00108382703528, 1.00108382703528,
                    1.00108382703528, 1.00108382703528, 1.00108382703528, 1.00108382703528, 1.00108382703528,
                    1.00108382703528, 1.00108382703528, 1.00108382703528, 1.00108382703528, 1.00108382703528,
                    1.00108382703528, 1.00108382703528, 1.00108382703528, 1.00108382703528, 1.00108382703528,
                    1.00108382703528, 1.00108382703528, 1.00108382703528, 1.00108382703528, 1.00108382703528,
                    1.00108382703528, 1.00108382703528, 1.00108382703528, 1.00108382703528, 1.00108382703528,
                    1.00108382703528, 1.00108382703378, 0.929973920196624, 0.787754106519309, 0.503314479167691,
                    0.112209991557777, 0.112209991557777, 0.112209991557777, 0.112209991557777, 0.112209991557777,
                    0.112209991557777, 0.112209991557777, 0.112209991557777, 0.112209991557777, 0.112209991557777,
                    0.112209991557777, 0.112209991557777, 0.112209991557777, 0.112209991557777, 0.112209991557777,
                    0.112209991557777, 0.112088060990496, 0.111844199855934, 0.111356477586809, 0.110990685884971,
                    0.110990685884969, 0.110990685884969, 0.110990685884969, 0.110990685884969, 0.110990685884969,
                    0.110990685884969, 0.110990685884969, 0.110990685884969, 0.110990685884969, 0.110990685884969,
                    0.110990685884969, 0.110990685884969, 0.110990685884969, 0.110990685884969, 0.110990685884969,
                    0.110990685884969, 0.110990685884969, 0.110990685884969, 0.110990685884969
                }
            };

            // Analyze
            AnalyzeTransient(tran, ckt, exports, references);
            DestroyExports(exports);
        }

        [Test]
        public void When_TerminatedFrequency_Expect_Reference()
        {
            // Parameters
            double rsource = 100.0, rload = 25.0;
            double impedance = 50.0, delay = 1.0e-6;

            // Build the circuit
            var ckt = new Circuit(
                new VoltageSource("V1", "in", "0", 0.0)
                    .SetParameter("acmag", 1.0),
                new Resistor("Rsource", "in", "a", rsource),
                new LosslessTransmissionLine("T1", "a", "0", "b", "0", impedance, delay),
                new Resistor("Rload", "b", "0", rload));

            // Build the analysis
            var ac = new AC("ac", new DecadeSweep(0.1, 1e8, 5));
            var exports = new IExport<Complex>[]
            {
                new ComplexVoltageExport(ac, "a"),
                new ComplexVoltageExport(ac, "b"),
            };

            double rsnorm = rsource / impedance, rlnorm = rload / impedance;
            var references = new Func<double, Complex>[]
            {
                frequency =>
                {
                    var k = Complex.Exp(-ac.GetState<IComplexSimulationState>().Laplace * delay);
                    k = (k * k - 1) / (k * k + 1);
                    return (k - rlnorm) / ((1 + rlnorm * rsnorm) * k - rsnorm - rlnorm);
                },
                frequency =>
                {
                    var k = Complex.Exp(-ac.GetState<IComplexSimulationState>().Laplace * delay);
                    return -2 * rlnorm * k / (k * k + 1) /
                           ((1 + rlnorm * rsnorm) * (k * k - 1) / (k * k + 1) - rsnorm - rlnorm);
                }
            };

            // Analyze
            AnalyzeAC(ac, ckt, exports, references);
            DestroyExports(exports);
        }
    }
}
